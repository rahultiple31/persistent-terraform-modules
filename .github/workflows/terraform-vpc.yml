name: Terraform VPC â€” Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select the environment to deploy"
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod
      action:
        description: "Select Terraform action"
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy

permissions:
  contents: read
  id-token: write
  actions: read

concurrency:
  group: terraform-vpc-${{ github.event.inputs.environment }}
  cancel-in-progress: true

env:
  AWS_REGION: eu-west-1
  TF_VERSION: 1.5.0

jobs:
  terraform:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ðŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ“ Set working directory and state key
        id: vars
        run: |
          ENV_NAME=${{ github.event.inputs.environment }}
          ACTION=${{ github.event.inputs.action }}
          WORKDIR="infrastructure/${ENV_NAME}/vpc"
          STATE_KEY="state/${ENV_NAME}/vpc/terraform.tfstate"

          echo "ENV_NAME=${ENV_NAME}" >> $GITHUB_ENV
          echo "ACTION=${ACTION}" >> $GITHUB_ENV
          echo "WORKDIR=${WORKDIR}" >> $GITHUB_ENV
          echo "STATE_KEY=${STATE_KEY}" >> $GITHUB_ENV

      - name: ðŸ§± Terraform Init (S3 backend)
        working-directory: ${{ env.WORKDIR }}
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=${{ env.STATE_KEY }}" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true"

      - name: ðŸ§© Terraform Format & Validate
        working-directory: ${{ env.WORKDIR }}
        run: |
          terraform fmt -check || true
          terraform fmt
          terraform validate

      - name: ðŸ§® Terraform Plan
        if: ${{ env.ACTION == 'plan' }}
        working-directory: ${{ env.WORKDIR }}
        run: |
          PLAN_FILE="plan-${{ env.ENV_NAME }}.tfplan"
          terraform plan -input=false -out="${PLAN_FILE}"
          terraform show -no-color "${PLAN_FILE}" > "${PLAN_FILE}.txt"
          # Encode binary plan safely for upload
          base64 "${PLAN_FILE}" > "${PLAN_FILE}.b64"

      - name: ðŸ“¤ Upload Plan Artifact
        if: ${{ env.ACTION == 'plan' }}
        uses: actions/upload-artifact@v4
        with:
          name: tf-plan-${{ env.ENV_NAME }}
          path: |
            ${{ env.WORKDIR }}/plan-${{ env.ENV_NAME }}.tfplan.b64
            ${{ env.WORKDIR }}/plan-${{ env.ENV_NAME }}.tfplan.txt

      - name: ðŸ“¥ Download Plan Artifact
        if: ${{ env.ACTION == 'apply' }}
        uses: actions/download-artifact@v4
        with:
          name: tf-plan-${{ env.ENV_NAME }}
          path: ${{ env.WORKDIR }}

      - name: ðŸ”„ Decode Plan File
        if: ${{ env.ACTION == 'apply' }}
        working-directory: ${{ env.WORKDIR }}
        run: |
          base64 --decode plan-${{ env.ENV_NAME }}.tfplan.b64 > plan-${{ env.ENV_NAME }}.tfplan

      - name: ðŸš€ Terraform Apply
        if: ${{ env.ACTION == 'apply' }}
        working-directory: ${{ env.WORKDIR }}
        run: |
          terraform apply -input=false -auto-approve plan-${{ env.ENV_NAME }}.tfplan

      - name: ðŸ’¥ Terraform Destroy
        if: ${{ env.ACTION == 'destroy' }}
        working-directory: ${{ env.WORKDIR }}
        run: |
          terraform destroy -input=false -auto-approve
