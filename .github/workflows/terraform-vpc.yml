name: Terraform VPC ‚Äî Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select the environment to deploy"
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod

permissions:
  contents: read
  id-token: write
  actions: read
  metadata: read

concurrency:
  group: terraform-vpc-${{ github.event.inputs.environment }}
  cancel-in-progress: true

env:
  AWS_REGION: eu-west-1
  TF_VERSION: 1.5.0

jobs:
  terraform:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: üîê Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üìÅ Set working directory and state key
        id: vars
        run: |
          ENV_NAME=${{ github.event.inputs.environment }}
          WORKDIR="persistent-terraform-modules/infrastructure/${ENV_NAME}/vpc"
          STATE_KEY="state/${ENV_NAME}/vpc/terraform.tfstate"

          echo "ENV_NAME=${ENV_NAME}" >> $GITHUB_ENV
          echo "WORKDIR=${WORKDIR}" >> $GITHUB_ENV
          echo "STATE_KEY=${STATE_KEY}" >> $GITHUB_ENV

      - name: üß± Terraform Init (S3 backend)
        working-directory: ${{ env.WORKDIR }}
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=${{ env.STATE_KEY }}" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true"

      - name: üß© Terraform Format & Validate
        working-directory: ${{ env.WORKDIR }}
        run: |
          terraform fmt -check || terraform fmt
          terraform validate

      - name: üßÆ Terraform Plan
        working-directory: ${{ env.WORKDIR }}
        run: |
          PLAN_FILE="plan-${{ env.ENV_NAME }}.tfplan"
          terraform plan -input=false -out="${PLAN_FILE}"
          terraform show -no-color "${PLAN_FILE}" > "${PLAN_FILE}.txt"

      - name: üì§ Upload Terraform plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tf-plan-${{ env.ENV_NAME }}
          path: |
            ${{ env.WORKDIR }}/plan-${{ env.ENV_NAME }}.tfplan
            ${{ env.WORKDIR }}/plan-${{ env.ENV_NAME }}.tfplan.txt

      - name: üöÄ Terraform Apply (Auto for Dev/QA)
        if: ${{ env.ENV_NAME != 'prod' }}
        working-directory: ${{ env.WORKDIR }}
        run: |
          terraform apply -auto-approve -input=false plan-${{ env.ENV_NAME }}.tfplan

      - name: ‚è∏Ô∏è Terraform Apply (Manual Approval for Prod)
        if: ${{ env.ENV_NAME == 'prod' }}
        working-directory: ${{ env.WORKDIR }}
        run: |
          echo "üîí Awaiting manual approval for PROD environment..."
          echo "Please approve the job in the 'prod' environment in GitHub UI before continuing."
          terraform apply -input=false plan-${{ env.ENV_NAME }}.tfplan
